<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.suzyne.shop.domain.membership.dao.ShopMembershipDao">
<select id="findAddressSeq" parameterType="int" resultType="int">
SELECT seq
FROM account_address  
WHERE account_no = #{account_no}
AND is_default_address =1
</select>
<select id="queryMembershipId" parameterType="int" resultType="String">
SELECT membership_id 
FROM customer c2
WHERE account_no = #{accountNo}
</select>
<select id="membershipDupCheck" parameterType="String" resultType="int">
SELECT COUNT(account_no)
FROM customer c 
WHERE membership_id = #{membershipId}
</select>
<insert id="saveMemProfile" parameterType="com.suzyne.shop.domain.profile.vo.ProfileDto">
MERGE customer AS a
USING (SELECT #{accountNo} AS account_no
			, #{firstName} AS first_name
			, #{lastName}  AS last_name
			, #{membershipId}  AS membership_id
			, #{customerEmail}		  AS customer_email
			, #{customerPhoneNumber}  AS customer_phone_number
			, #{extensionNumber}      AS extension_nember
	   ) AS b
	ON(
			a.account_no =b.account_no
	   )
	   WHEN NOT MATCHED THEN
	   		INSERT ( account_no
                    , first_name
                    , last_name
                    , customer_email
                    , customer_phone_number
                    , extension_nember
                    , customer_gender
                    , customer_kr_nm
                    , customer_en_nm
                    , customer_lang_cd
                    , membership_id
                    , is_membership
                    , reg_date
                    , reg_person
                    , last_mod_date
                    , last_mod_person
	   		) VALUES(
	   				  b.account_no
                    , b.first_name
                    , b.last_name
                    , b.customer_email
                    , b.customer_phone_number
                    , b.extension_nember
                    , NULL
                    , NULL
                    , NULL
                    , NULL
                    , b.membership_id
                    , 1
                    , getdate()
                    , b.account_no
                    , NULL
                    , NULL
	   		)
	  WHEN MATCHED THEN
	  		UPDATE
	  		SET   a.account_no = b.account_no
                  , a.first_name = b.first_name
                  , a.last_name = b.last_name
                  , a.membership_id = b.membership_id
                  , a.is_membership = 1
                  , a.customer_email = b.customer_email
                  , a.customer_phone_number = b.customer_phone_number
                  , a.extension_nember = b.extension_nember;                  
</insert>
<insert id="saveMemAddress" parameterType="com.suzyne.shop.domain.profile.vo.AddressDto">
MERGE account_address AS a
USING (SELECT #{accountNo} AS account_no
			, #{seq}   AS seq
			, #{address}   AS address
			, #{city}  	   AS city
			, #{province}  AS province
			, #{country}   AS country
			, #{postalCd}  AS postal_cd
			, #{isDefaultAddress}  AS is_default_address
	   ) AS b
	ON(
			a.account_no = b.account_no
			and a.seq = b.seq
	   )
	   WHEN NOT MATCHED THEN
	   		INSERT ( account_no
                    , address
                    , city
                    , province
                    , country
                    , postal_cd
                    , is_default_address
                    , reg_date
                    , reg_person
                    , last_mod_date
                    , last_mod_person
	   		) VALUES(
                      b.account_no
                    , b.address
                    , b.city
                    , b.province
                    , b.country
                    , b.postal_cd
                    , 1
                    , getdate()
                    , b.account_no
                    , NULL
                    , NULL
	   		)
	  WHEN MATCHED THEN
	  		UPDATE
	  		SET   a.account_no = b.account_no	  			  
                  , a.address = b.address
                  , a.city = b.city
                  , a.province = b.province
                  , a.country = b.country
                  , a.postal_cd = b.postal_cd;                                    
</insert>
</mapper>
