<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.suzyne.shop.domain.payment.dao.PaymentDao">
<select id="find" parameterType="com.suzyne.shop.domain.payment.vo.PaymentSearch" resultType="com.suzyne.shop.domain.payment.vo.PaymentDto">
select payment_id       as paymentId
     , card_name        as cardName
     , right(card_no,4) as cardLastNo
     , expiration_month as expirationMonth
     , expiration_year  as expirationYear
     , is_default       as isDefaultPayment
 from payment
where account_no = #{accountNo}
</select>

<select id="findByDefault" parameterType="com.suzyne.shop.domain.payment.vo.PaymentSearch" resultType="com.suzyne.shop.domain.payment.vo.PaymentDto">
select top 1
       payment_id       as paymentId
     , card_name        as cardName
     , right(card_no,4) as cardLastNo
     , expiration_month as expirationMonth
     , expiration_year  as expirationYear
     , is_default       as isDefaultPayment
 from payment
where account_no = #{accountNo}
  and is_default = 1
</select>

<select id="findById" parameterType="com.suzyne.shop.domain.payment.vo.PaymentSearch" resultType="com.suzyne.shop.domain.payment.vo.Payment">
select payment_id       as paymentId
     , card_no          as cardNo
     , card_name        as cardName
     , expiration_month as expirationMonth
     , expiration_year  as expirationYear
     , card_verification_code as cardVerificationCode
 from payment
where account_no = #{accountNo}
  and payment_id = #{paymentId}
</select>

<insert id="insert" parameterType="com.suzyne.shop.domain.payment.vo.Payment">
insert into payment (
       account_no
     , card_no
     , card_name
     , expiration_month
     , expiration_year
     , card_verification_code
     , is_default
     , reg_date
     , reg_person
     , last_mod_date
     , last_mod_person
) values (
       #{accountNo}
     , #{cardNo}
     , #{cardName}
     , #{expirationMonth}
     , #{expirationYear}
     , #{cardVerificationCode}
     , #{isDefault}
     , getDate()
     , #{accountNo}
     , getDate()
     , #{accountNo}
)
</insert>

<update id="save" parameterType="com.suzyne.shop.domain.payment.vo.Payment">
update payment
   set last_mod_date = getDate()
     , last_mod_person = #{accountNo}
     , is_default = #{isDefault}
 where account_no = #{accountNo}
   and payment_id = #{paymentId}
</update>

<update id="saveDefaultAllFalse" parameterType="com.suzyne.shop.domain.payment.vo.Payment">
update payment
   set last_mod_date = getDate()
     , last_mod_person = #{accountNo}
     , is_default = 0
 where account_no = #{accountNo}
</update>

<delete id="delete" parameterType="com.suzyne.shop.domain.payment.vo.Payment">
delete payment
 where account_no = #{accountNo}
   and payment_id = #{paymentId}
</delete>

<insert id="saveReqRequestCardTranjection" parameterType="com.suzyne.shop.domain.payment.vo.CardPaymentResultVO">
insert into card_payment_result (
  request_uuid
, store_id
, account_no
, order_id
, invoice_id
, ssl_transaction_type
, ssl_card_number
, ssl_card_type
, ssl_amount
, reg_date
, reg_person
, last_mod_date
, last_mod_person
) values (
  #{requestUuid}
, #{storeId}
, #{accountNo}
, #{orderId}
, #{invoiceId}
, #{sslTransactionType}
, #{sslCardNumber}
, #{sslCardType}
, #{sslAmount}
, getDate()
, #{accountNo}
, getDate()
, #{accountNo}
)
</insert>

<update id="saveResRequestCardTranjection" parameterType="com.suzyne.shop.domain.payment.vo.CardPaymentResultVO">
update card_payment_result
   set last_mod_date = getDate()
     , last_mod_person = #{accountNo}
     , ssl_txn_id = #{sslTxnId}
     , ssl_txn_time = #{sslTxnTime}
     , ssl_result_message = #{sslResultMessage}
     , ssl_approval_code = #{sslApprovalCode}
     , ssl_result = #{sslResult}
     , error_code = #{errorCode}
     , error_name = #{errorName}
     , error_message = #{errorMessage}
 where request_uuid = #{requestUuid}
</update>

</mapper>